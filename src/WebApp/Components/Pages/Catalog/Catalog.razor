@page "/"
@inject NavigationManager Nav
@inject CatalogService CatalogService
@attribute [StreamRendering]

<PageTitle>AdventureWorks</PageTitle>
<SectionContent SectionName="page-header-title">Ready for a new adventure?</SectionContent>
<SectionContent SectionName="page-header-subtitle">Start the season with the latest in clothing and equipment.</SectionContent>

<div class="catalog">
    <CatalogSearch BrandId="@BrandId" ItemTypeId="@ItemTypeId" SearchTerm="@SearchTerm" />

    @if (catalogResult is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="catalog-results">
            @if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                <div class="search-results-header">
                    <span class="search-results-count">@catalogResult.Count results for "<strong>@SearchTerm</strong>"</span>
                </div>
            }

            @if (catalogResult.Data.Count == 0)
            {
                <div class="no-results">
                    <h3>No products found</h3>
                    @if (!string.IsNullOrWhiteSpace(SearchTerm))
                    {
                        <p>We couldn't find any products matching "<strong>@SearchTerm</strong>".</p>
                        <p>Try adjusting your search or <a href="@ClearSearchUrl()">browse all products</a>.</p>
                    }
                    else
                    {
                        <p>No products match your current filters.</p>
                    }
                </div>
            }
            else
            {
                <div class="catalog-items">
                    @foreach (var item in catalogResult.Data)
                    {
                        <CatalogListItem Item="@item" SearchTerm="@SearchTerm" />
                    }
                </div>

                <div class="page-links">
                    @foreach (var pageIndex in GetVisiblePageIndexes(catalogResult))
                    {
                        <NavLink ActiveClass="active-page" Match="@NavLinkMatch.All" href="@GetPageUrl(pageIndex)">@pageIndex</NavLink>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    const int PageSize = 9;

    [SupplyParameterFromQuery]
    public int? Page { get; set; }

    [SupplyParameterFromQuery(Name = "brand")]
    public int? BrandId { get; set; }

    [SupplyParameterFromQuery(Name = "type")]
    public int? ItemTypeId { get; set; }

    [SupplyParameterFromQuery(Name = "q")]
    public string? SearchTerm { get; set; }

    CatalogResult? catalogResult;

    static IEnumerable<int> GetVisiblePageIndexes(CatalogResult result)
        => Enumerable.Range(1, (int)Math.Ceiling(1.0 * result.Count / PageSize));

    protected override async Task OnInitializedAsync()
    {
        catalogResult = await CatalogService.GetCatalogItems(
            Page.GetValueOrDefault(1) - 1,
            PageSize,
            BrandId,
            ItemTypeId,
            SearchTerm);
    }

    private string GetPageUrl(int pageIndex)
    {
        return Nav.GetUriWithQueryParameters(new Dictionary<string, object?>()
        {
            { "page", pageIndex == 1 ? null : pageIndex },
            { "brand", BrandId },
            { "type", ItemTypeId },
            { "q", SearchTerm }
        });
    }

    private string ClearSearchUrl()
    {
        return Nav.GetUriWithQueryParameters(new Dictionary<string, object?>()
        {
            { "page", null },
            { "brand", BrandId },
            { "type", ItemTypeId },
            { "q", null }
        });
    }
}
