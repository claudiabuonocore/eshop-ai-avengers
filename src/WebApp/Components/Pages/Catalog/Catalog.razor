@page "/catalog"
@inject NavigationManager Nav
@inject CatalogService CatalogService
@attribute [StreamRendering]

<PageTitle>Product Catalog - AdventureWorks</PageTitle>

<div class="catalog-page">
    <div class="page-header">
        <h1 class="page-title">Explore Our Gear</h1>
        <p class="page-subtitle">Find the perfect equipment for your next outdoor adventure.</p>
    </div>
    
    <div class="catalog">
    <CatalogSearch BrandId="@BrandId" ItemTypeId="@ItemTypeId" SearchTerm="@SearchTerm" />

    @if (catalogResult is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="catalog-results">
            @if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                <div class="search-results-header">
                    <span class="search-results-count">@catalogResult.Count results for "<strong>@SearchTerm</strong>"</span>
                </div>
            }

            @if (catalogResult.Data.Count == 0)
            {
                <div class="no-results">
                    <h3>No products found</h3>
                    @if (!string.IsNullOrWhiteSpace(SearchTerm))
                    {
                        <p>We couldn't find any products matching "<strong>@SearchTerm</strong>".</p>
                        <p>Try adjusting your search or <a href="@ClearSearchUrl()">browse all products</a>.</p>
                    }
                    else
                    {
                        <p>No products match your current filters.</p>
                    }
                </div>
            }
            else
            {
                <div class="catalog-items">
                    @foreach (var item in catalogResult.Data)
                    {
                        <CatalogListItem 
                            Item="@item" 
                            SearchTerm="@SearchTerm"
                            OnQuickViewRequested="@HandleQuickView" />
                    }
                </div>

                <div class="page-links">
                    @foreach (var pageIndex in GetVisiblePageIndexes(catalogResult))
                    {
                        <NavLink ActiveClass="active-page" Match="@NavLinkMatch.All" href="@GetPageUrl(pageIndex)">@pageIndex</NavLink>
                    }
                </div>
            }
        </div>
    }
    </div>
</div>

<QuickViewModal 
    IsVisible="@showQuickView"
    Product="@selectedProduct"
    OnClose="@CloseQuickView"
    OnAddToCartRequested="@HandleAddToCart" />

@code {
    const int PageSize = 9;

    [SupplyParameterFromQuery]
    public int? Page { get; set; }

    [SupplyParameterFromQuery(Name = "brand")]
    public int? BrandId { get; set; }

    [SupplyParameterFromQuery(Name = "type")]
    public int? ItemTypeId { get; set; }

    [SupplyParameterFromQuery(Name = "q")]
    public string? SearchTerm { get; set; }

    CatalogResult? catalogResult;
    bool showQuickView = false;
    CatalogItem? selectedProduct = null;

    static IEnumerable<int> GetVisiblePageIndexes(CatalogResult result)
        => Enumerable.Range(1, (int)Math.Ceiling(1.0 * result.Count / PageSize));

    protected override async Task OnInitializedAsync()
    {
        catalogResult = await CatalogService.GetCatalogItems(
            Page.GetValueOrDefault(1) - 1,
            PageSize,
            BrandId,
            ItemTypeId,
            SearchTerm);
    }

    private void HandleQuickView(CatalogItem item)
    {
        selectedProduct = item;
        showQuickView = true;
    }

    private void CloseQuickView()
    {
        showQuickView = false;
        selectedProduct = null;
    }

    private void HandleAddToCart(CatalogItem item)
    {
        // Add to cart logic to be implemented
        // For now, just close the modal
        CloseQuickView();
    }

    private string GetPageUrl(int pageIndex)
    {
        return Nav.GetUriWithQueryParameters(new Dictionary<string, object?>()
        {
            { "page", pageIndex == 1 ? null : pageIndex },
            { "brand", BrandId },
            { "type", ItemTypeId },
            { "q", SearchTerm }
        });
    }

    private string ClearSearchUrl()
    {
        return Nav.GetUriWithQueryParameters(new Dictionary<string, object?>()
        {
            { "page", null },
            { "brand", BrandId },
            { "type", ItemTypeId },
            { "q", null }
        });
    }
}
